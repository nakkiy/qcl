# ✅ qcl-app クレート設計書（アプリケーション層・完全版／AppContext対応版）

---

## ✅ 1. 概要  
`qcl-app` クレートは、qcl プロジェクトの実行エントリーポイントを提供する**アプリケーション層**。  
CLI / TUI サブコマンドを通じて、スニペット選択・コマンド解決のフローを統括し、  
ユーザーへ最終コマンドを提示する。  
UIとログを分離し、ファイルベースのログ出力を採用することでTUI/CLIの整合性を保つ。

---

## ✅ 2. クレートの責務

| カテゴリ                  | 内容                                                                                     |
|---------------------------|------------------------------------------------------------------------------------------|
| ✅ 実行エントリーポイント | CLI / TUI サブコマンドの切り替えと起動                                                 |
| ✅ 環境初期化              | ロガー初期化（ファイル出力限定）、設定ファイルロード                                   |
| ✅ resolve 呼び出し        | スニペットのロード、インターフェース初期化、resolve 実行                               |
| ✅ コマンド出力            | 最終的なコマンド文字列の標準出力 or ファイル出力                                       |
| ✅ エラー処理              | エラーのログ記録とプロセス終了コード管理                                               |

---

## ✅ 3. クレートの非責務

| 項目                   | 説明                                                             |
|------------------------|------------------------------------------------------------------|
| ❌ プレースホルダ解決   | `resolve` クレートが担当                                          |
| ❌ UI の実装           | `interface` クレートが担当                                       |
| ❌ スニペット管理       | `snippet` クレートが担当                                         |
| ❌ コマンドの実行       | qcl-app はコマンド文字列を出力するのみ（自動実行はしない）      |

---

## ✅ 4. モジュール構成

```
qcl-app/
├── Cargo.toml
└── src/
    ├── main.rs        
    ├── cli.rs         
    ├── tui.rs         
    └── logger.rs      
```

---

## ✅ 5. コマンドライン引数仕様

| オプション       | 内容                                               |
|------------------|----------------------------------------------------|
| `--log-level`    | ログレベルを指定（info / debug / trace）。省略時は **info** |
| `--log-file`     | ログ出力先ファイルパス。省略時はログ出力しない    |
| `--file`, `-f`   | 追加スニペットファイルのパス。省略時はデフォルトファイルのみ |
| subcommand       | `cli` / `tui` サブコマンド                        |

---

## ✅ 6. 実行フローと関数シグネチャ

---

### 📄 main.rs

#### ✅ 関数シグネチャ
```rust
fn main() -> anyhow::Result<()>;
```

#### ✅ 実行フロー
```
1. CLI引数をパース
2. AppContext を生成
3. logger を初期化
4. CLI / TUI モードに応じて run_cli() / run_tui() を呼び出す
```

---

### 📄 AppContext（main.rs）

#### ✅ 構造体
```rust
pub struct AppContext {
    pub file: Option<String>,
    pub log_level: String,
    pub log_file: Option<String>,
}
```

---

### 📄 cli.rs

#### ✅ 関数シグネチャ
```rust
pub fn run_cli(ctx: AppContext) -> anyhow::Result<()>;
```

#### ✅ 処理内容
```
1. ctx.file を使用してスニペットファイルをロード
2. interface::create_cli_provider() を呼び出し ValueProvider を取得
3. resolve::run_qcl() を実行
4. 解決されたコマンドを標準出力に表示
```

---

### 📄 tui.rs

#### ✅ 関数シグネチャ
```rust
pub fn run_tui(ctx: AppContext) -> anyhow::Result<()>;
```

#### ✅ 処理内容
```
1. ctx.file を使用してスニペットファイルをロード
2. interface::create_tui_provider() を呼び出し ValueProvider を取得
3. resolve::run_qcl() を実行
4. 解決されたコマンドを標準出力に表示
```

---

### 📄 logger.rs

#### ✅ 関数シグネチャ
```rust
pub fn init_logger(log_level: &str, log_file: Option<String>);
```

---

## ✅ 7. スニペットファイルの読み込み仕様

| 条件                                | 処理                                                   |
|-------------------------------------|--------------------------------------------------------|
| デフォルトファイル読み込み           | `~/.config/qcl/snippets.yaml` を常に読み込む          |
| `--file` / `-f` 指定あり             | 指定ファイルを追加で読み込む                          |
| 重複するスニペット名が存在した場合   | **後勝ちルール**（`--file` 指定ファイルが優先される） |

---

## ✅ 8. ログ設計

### 基本ポリシー
| 項目                   | 内容                                                  |
|------------------------|-------------------------------------------------------|
| ログ出力先             | ファイルのみ                                          |
| stdout / stderr 出力   | ログは一切流さない                                   |
| ログレベル制御         | `--log-level` で指定（省略時は **info**）             |
| ログファイル制御       | `--log-file` で指定                                   |
| 環境変数 `RUST_LOG`    | 無視する                                              |

### 動作ルール
| 条件                                   | 動作                                   |
|----------------------------------------|----------------------------------------|
| `--log-file` なし、`--log-level` なし  | ログ出力なし（デフォルト動作）        |
| `--log-file` なし、`--log-level` 指定  | ログ出力なし（出力先が無いため）      |
| `--log-file` 指定、`--log-level` なし  | **info** レベルでファイルにログ出力開始 |
| `--log-file` 指定、`--log-level` 指定  | 指定レベルでファイルにログ出力開始    |

---

## ✅ 9. ログイベント一覧（アプリケーション層）

| レベル  | イベント名              | 出力情報                                  |
|--------|-------------------------|-------------------------------------------|
| INFO   | app_start               | コマンド名、引数                          |
| INFO   | app_mode_selected       | サブコマンド名（cli / tui）               |
| DEBUG  | snippet_file_specified  | ファイルパス                              |
| INFO   | command_generated       | コマンド文字列                            |
| ERROR  | app_error               | エラーメッセージ                          |

---

## ✅ 10. 実行例

```bash
qcl cli
qcl cli --file ./snippets/custom.yaml
qcl cli --file ./snippets/custom.yaml --log-level trace --log-file ./qcl.log
qcl tui
```

---

## ✅ 11. 依存ライブラリ

```toml
[dependencies]
anyhow = "1.0"
clap = { version = "4.0", features = ["derive"] }
tracing = "0.1"
tracing-subscriber = "0.3"
snippet = { path = "../crates/snippet" }
resolve = { path = "../crates/resolve" }
interface = { path = "../crates/interface" }
```

---

## ✅ 12. 将来の拡張案

| 項目                       | 内容                                |
|----------------------------|-------------------------------------|
| REST API サーバーモード     | HTTP リクエストでスニペット解決     |
| Web UI モード              | フロントエンド＋バックエンド実装    |
| 設定ファイルカスタマイズ   | デフォルトログレベル・ファイルを管理 |
| バッチモード              | 複数スニペット一括解決・出力        |

---

## ✅ 13. qcl-app クレートの責務まとめ

### ✅ やること
- CLI/TUI サブコマンドの起動とモード切り替え  
- ファイルロガー初期化  
- スニペットロードと resolve 実行制御  
- コマンド出力とエラー処理

### ❌ やらないこと
- プレースホルダ解決（resolve）  
- UI 実装（interface）  
- スニペットパース・構造管理（snippet）
