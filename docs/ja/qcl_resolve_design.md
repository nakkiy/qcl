# âœ… resolve ã‚¯ãƒ¬ãƒ¼ãƒˆè¨­è¨ˆæ›¸ï¼ˆengineå±¤ãƒ»æœ€æ–°ç‰ˆï¼orderãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£ç‰ˆï¼‰

---

## âœ… 1. æ¦‚è¦  
`resolve` ã‚¯ãƒ¬ãƒ¼ãƒˆã¯ã€qcl ã® **ã‚¨ãƒ³ã‚¸ãƒ³å±¤**ã€‚  
ã‚¹ãƒ‹ãƒšãƒƒãƒˆå†…ã«å«ã¾ã‚Œã‚‹ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’å‹•çš„ã«è§£æ±ºã—ã€æœ€çµ‚çš„ãªã‚³ãƒãƒ³ãƒ‰æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ã€‚  
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã¯ `interface` ã‚¯ãƒ¬ãƒ¼ãƒˆãŒæ‹…å½“ã—ã€  
`ValueProvider` ãƒˆãƒ¬ã‚¤ãƒˆã‚’é€šã˜ã¦æŠ½è±¡åŒ–ã™ã‚‹ã“ã¨ã§ UI éä¾å­˜ã®å®Ÿè£…ã‚’å®Ÿç¾ã™ã‚‹ã€‚

---

## âœ… 2. ã‚¯ãƒ¬ãƒ¼ãƒˆã®è²¬å‹™

| ã‚«ãƒ†ã‚´ãƒª              | å†…å®¹                                                                                 |
|-----------------------|--------------------------------------------------------------------------------------|
| âœ… ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€è§£æ±º | ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼ˆPlaceholderï¼‰ã®å€¤ã‚’æ±ºå®šã—ã€ã‚³ãƒãƒ³ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åŸ‹ã‚è¾¼ã‚€å‡¦ç†         |
| âœ… Functionå®Ÿè¡Œ       | Function å®šç¾©ãŒã‚ã‚‹å ´åˆã«å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€çµæœã‚’è§£é‡ˆã—ã¦å€™è£œãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹     |
| âœ… UIã¸ã®å•ã„åˆã‚ã›  | ValueProvider ãƒˆãƒ¬ã‚¤ãƒˆã«ã‚ˆã‚‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®æŠ½è±¡åŒ–                     |
| âœ… è§£æ±ºçŠ¶æ…‹ã®ä¿æŒ    | ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€å â†’ å€¤ã®è§£æ±ºæ¸ˆã¿ãƒãƒƒãƒ—ã‚’ç®¡ç†ã—ã€å†åˆ©ç”¨/äºŒé‡å…¥åŠ›ã‚’é˜²ã               |
| âœ… æœ€çµ‚ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆ  | è§£æ±ºå¾Œã®ã‚³ãƒãƒ³ãƒ‰æ–‡å­—åˆ—ã‚’è¿”å´ï¼ˆå®Ÿè¡Œã¯ã—ãªã„ï¼‰                                      |

---

## âœ… 3. ã‚¯ãƒ¬ãƒ¼ãƒˆã®éè²¬å‹™

| é …ç›®                | èª¬æ˜                                                                 |
|---------------------|----------------------------------------------------------------------|
| âŒ UIè¡¨ç¤ºï¼å…¥å‡ºåŠ›    | `interface` ã‚¯ãƒ¬ãƒ¼ãƒˆã®è²¬å‹™                                           |
| âŒ ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ      | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚³ãƒãƒ³ãƒ‰ã‚’æç¤ºã™ã‚‹ã ã‘ã§ã€å®Ÿè¡Œã¯ã—ãªã„ï¼ˆqcl-appã®è²¬å‹™ï¼‰   |
| âŒ ã‚¹ãƒ‹ãƒšãƒƒãƒˆç®¡ç†    | `snippet` ã‚¯ãƒ¬ãƒ¼ãƒˆã®è²¬å‹™                                            |
| âŒ ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰å®Ÿè£…  | CLI/TUIåˆ‡æ›¿ã‚„ã‚¢ãƒ—ãƒªã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¯ `qcl-app` ã‚¯ãƒ¬ãƒ¼ãƒˆãŒè¡Œã†     |

---

## âœ… 4. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ

```
crates/resolve/
â”œâ”€â”€ Cargo.toml
â””â”€â”€ src/
    â”œâ”€â”€ lib.rs
    â”œâ”€â”€ resolver.rs    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€è§£æ±ºã‚¨ãƒ³ã‚¸ãƒ³
    â””â”€â”€ provider.rs    // UIæŠ½è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼ (ValueProvider ãƒˆãƒ¬ã‚¤ãƒˆ)
```

---

## âœ… 5. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨æ§‹é€ ä½“è©³ç´°

### ğŸ“ resolver.rs

#### âœ… å…¬é–‹é–¢æ•°

##### ã€1ã€‘run_qcl
```rust
pub fn run_qcl<P: ValueProvider>(
    snippets: &[Snippet],
    mut provider: P
) -> anyhow::Result<String>;
```

##### ã€2ã€‘resolve_placeholders
```rust
pub fn resolve_placeholders<P: ValueProvider>(
    snippet: &Snippet,
    provider: &mut P
) -> anyhow::Result<String>;
```

#### âœ… éå…¬é–‹é–¢æ•°
```rust
fn process_function(function: &Function) -> anyhow::Result<Vec<Vec<String>>>;

fn resolve_placeholder<P: ValueProvider>(
    ph: &Placeholder,
    function: &Option<Function>,
    vars: &mut HashMap<String, String>,
    provider: &mut P
) -> anyhow::Result<()>;

fn render_command(template: &str, vars: &HashMap<String, String>) -> String;
```

---

### ğŸ“ provider.rs
```rust
pub trait ValueProvider {
    fn prompt_input(
        &mut self,
        var_name: &str,
        prompt: &str,
        default: Option<String>
    ) -> anyhow::Result<String>;

    fn prompt_select(
        &mut self,
        var_name: &str,
        prompt: &str,
        records: Vec<Vec<String>>,
        display_columns: Vec<usize>,
        default_index: Option<usize>
    ) -> anyhow::Result<usize>;
}
```

---

## âœ… 6. ValueProvider ã«ã‚ˆã‚‹ interface ã¨ã®ã‚„ã‚Šå–ã‚Šä»•æ§˜

### ğŸ¯ åŸºæœ¬æ–¹é‡
- `resolve` ã‚¯ãƒ¬ãƒ¼ãƒˆã¯ UI ã‚’æŒãŸãªã„  
- `ValueProvider` ãƒˆãƒ¬ã‚¤ãƒˆã‚’é€šã˜ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¤–éƒ¨ã«å§”è­²ã™ã‚‹  
- `interface` ã‚¯ãƒ¬ãƒ¼ãƒˆã¯ `ValueProvider` ã‚’å®Ÿè£…ã—ã€å…·ä½“çš„ãª UI ã‚’æä¾›ã™ã‚‹

### ğŸ¯ å½¹å‰²ã®åˆ†æ‹…

| resolve ã‚¯ãƒ¬ãƒ¼ãƒˆ                   | interface ã‚¯ãƒ¬ãƒ¼ãƒˆ                       |
|-----------------------------------|-----------------------------------------|
| `ValueProvider` ãƒˆãƒ¬ã‚¤ãƒˆã‚’å®šç¾©     | `ValueProvider` ãƒˆãƒ¬ã‚¤ãƒˆã‚’å®Ÿè£…          |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å€¤ã‚’å–å¾—ã—ãŸã„å ´åˆã«ã€`ValueProvider` ã‚’å‘¼ã³å‡ºã™ | å®Ÿéš›ã«å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚„é¸æŠè‚¢ UI ã‚’æä¾›    |
| æˆ»ã‚Šå€¤ã‚’ä½¿ã£ã¦ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€è§£æ±ºã‚’é€²ã‚ã‚‹ | æˆ»ã‚Šå€¤ï¼ˆå…¥åŠ›å€¤ãƒ»è¡Œç•ªå·ï¼‰ã‚’è¿”å´ã™ã‚‹       |

---

### ğŸ¯ ãƒˆãƒ¬ã‚¤ãƒˆå®šç¾©
```rust
pub trait ValueProvider {
    fn prompt_input(
        &mut self,
        var_name: &str,
        prompt: &str,
        default: Option<String>
    ) -> anyhow::Result<String>;

    fn prompt_select(
        &mut self,
        var_name: &str,
        prompt: &str,
        records: Vec<Vec<String>>,
        display_columns: Vec<usize>,
        default_index: Option<usize>
    ) -> anyhow::Result<usize>;
}
```

### ğŸ¯ ã‚„ã‚Šå–ã‚Šãƒ•ãƒ­ãƒ¼
1. `resolve_placeholder()` å†…ã§ `prompt_input()` ã¾ãŸã¯ `prompt_select()` ã‚’å‘¼ã¶  
2. `interface` ã‚¯ãƒ¬ãƒ¼ãƒˆãŒãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚„ TUI ã‚’è¡¨ç¤º  
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ or è¡Œç•ªå·ãŒè¿”ã‚‹  
4. resolve å´ã§å€¤ã‚’ãƒãƒƒãƒ—ã«ç™»éŒ²ã—ã¦ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’è§£æ±ºã™ã‚‹

### ğŸ¯ ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œå›³
```
resolve::resolve_placeholder()
    â””â”€â”€ provider.prompt_input() / prompt_select()
        â””â”€â”€ interface::DialoguerProvider or TuiProvider
            â””â”€â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›/é¸æŠ
        â†â”€â”€ å€¤ï¼ˆString or usizeï¼‰ã‚’è¿”ã™
    â†â”€â”€ ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
```

## âœ… 7. ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€è§£æ±ºãƒ•ãƒ­ãƒ¼

```
run_qcl():
  â””â”€ snippeté¸æŠï¼ˆinterface::ValueProviderï¼‰
  â””â”€ resolve_placeholders():
      â”œâ”€ å„ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’é †æ¬¡å‡¦ç†
      â”œâ”€ from/command or function å®Ÿè¡Œâ†’recordsç”Ÿæˆ
      â”œâ”€ prompt_select()/prompt_input()ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
      â””â”€ æœ€çµ‚çš„ãªæ–‡å­—åˆ—ã‚’çµ„ã¿ç«‹ã¦
```

---

## âœ… 7.1 ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€è§£æ±ºã®é †åºãƒ«ãƒ¼ãƒ«ã€è¿½åŠ ã€‘

ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã®è§£æ±ºé †åºã¯ã€ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã†ã€‚

### âœ… å‡¦ç†é †åºãƒ«ãƒ¼ãƒ«
| çŠ¶æ³                          | å‡¦ç†é †åº                                      |
|-------------------------------|-----------------------------------------------|
| **order ãŒæŒ‡å®šã•ã‚ŒãŸãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€** | `order` ã®å€¤ã§æ˜‡é †ã«ã‚½ãƒ¼ãƒˆã—ã€é †ç•ªã«è§£æ±º      |
| **order ãŒç„¡ã„ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€**      | ãƒ‘ãƒ¼ã‚¹é †ï¼ˆã‚¹ãƒ‹ãƒšãƒƒãƒˆè¨˜è¿°é †ï¼‰ã§é †ç•ªã«è§£æ±º      |
| **order æŒ‡å®šã¨æœªæŒ‡å®šãŒæ··åœ¨**        | 1. `order` æŒ‡å®šã‚ã‚Šã‚’æ˜‡é †ã§è§£æ±º<br>2. æŒ‡å®šãªã—ã‚’ãƒ‘ãƒ¼ã‚¹é †ã§è§£æ±º |

### âœ… è©³ç´°ãƒ«ãƒ¼ãƒ«
- `order` ã®å€¤ã¯æ•´æ•°ï¼ˆæ­£ã®æ•°ã€0ãƒ™ãƒ¼ã‚¹å¯ï¼‰  
- `order` ãŒé£›ã³é£›ã³ã§ã‚‚å•é¡Œãªã—ï¼ˆæ˜‡é †ã§å‡¦ç†ï¼‰  
- `order` ãŒé‡è¤‡ã—ã¦ã„ã‚‹å ´åˆã€ãƒ‘ãƒ¼ã‚¹é †ã«è§£æ±ºã™ã‚‹  
- `order` ãŒä¸€åˆ‡æŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ã™ã¹ã¦ãƒ‘ãƒ¼ã‚¹é †ã§è§£æ±ºã•ã‚Œã‚‹  
- ç„¡åŠ¹ãª `order` å€¤ï¼ˆè² æ•°ã‚„ãƒ‘ãƒ¼ã‚¹ä¸èƒ½ãªã©ï¼‰ã¯ `snippet` ã‚¯ãƒ¬ãƒ¼ãƒˆã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆã¿ã¨ã™ã‚‹  
ï¼ˆresolve å´ã§ã¯ãƒã‚§ãƒƒã‚¯ã—ãªã„ï¼‰

### âœ… å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ
- `resolve_placeholders()` å†…ã§  
  - `order` ãŒ `Some` ãªã‚‚ã®ã¨ `None` ãªã‚‚ã®ã«åˆ†ã‘ã¦å‡¦ç†  
  - `Some(order)` ã¯æ˜‡é †ã‚½ãƒ¼ãƒˆå¾Œã«è§£æ±º  
  - `None` ã¯é †æ¬¡è§£æ±º  
- ã“ã®ãƒ«ãƒ¼ãƒ«ã¯**ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã®ä¾å­˜é–¢ä¿‚ã¨ã¯ç„¡é–¢ä¿‚**ã«é©ç”¨ã•ã‚Œã‚‹  
  - ä¾å­˜é–¢ä¿‚ã¯å°†æ¥çš„ãªæ©Ÿèƒ½ï¼ˆä¸¦åˆ—å‡¦ç†ã‚„ä¾å­˜è§£æ±ºï¼‰ã§æ‹¡å¼µäºˆå®š

---

## âœ… 8. tracing ãƒ­ã‚°è¨­è¨ˆ

### ğŸ¯ åŸºæœ¬ãƒãƒªã‚·ãƒ¼
- `tracing` ã§æ§‹é€ åŒ–ãƒ­ã‚°ã‚’å‡ºåŠ›  
- `qcl-app` ãŒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»å‡ºåŠ›ã‚’ç®¡ç†

### ğŸ¯ ãƒ­ã‚°ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§  
| ãƒ¬ãƒ™ãƒ«  | ã‚¤ãƒ™ãƒ³ãƒˆå                 | å†…å®¹                                           |
|--------|----------------------------|------------------------------------------------|
| TRACE  | placeholder_resolve_start   | snippet_name, placeholder_name                |
| TRACE  | placeholder_resolve_end     | snippet_name, placeholder_name, resolved_value|
| DEBUG  | placeholder_value_resolved  | var_name, value                               |
| DEBUG  | external_command_executed   | command, stdout_lines                         |
| ERROR  | external_command_failed     | command, error                                |
| ERROR  | no_snippet_found            | snippet_name                                  |

---

### ğŸ¯ å®Ÿè£…ä¾‹  
```rust
trace!(
    event = "placeholder_resolve_start",
    snippet_name = %snippet.name,
    placeholder_name = %ph.name
);

debug!(
    event = "placeholder_value_resolved",
    var_name = %ph.name,
    value = %resolved_value
);

error!(
    event = "external_command_failed",
    command = %cmd,
    error = %err
);
```

## âœ… 9. ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆCargo.tomlï¼‰
```toml
[dependencies]
anyhow = "1.0"
regex = "1.5"
tracing = "0.1"
snippet = { path = "../snippet" }
```

---

## âœ… 10. å°†æ¥ã®æ‹¡å¼µ

| é …ç›®                     | å†…å®¹                                       |
|--------------------------|--------------------------------------------|
| ä¸¦åˆ—ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€è§£æ±º    | ä¾å­˜é–¢ä¿‚ã®ãªã„ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’ä¸¦åˆ—å‡¦ç†     |
| å¤–éƒ¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚µãƒãƒ¼ãƒˆ | Function ã‚’å¤–éƒ¨ãƒ—ãƒ­ã‚»ã‚¹/ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«å§”è­² |
| å‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–     | int/float/bool ãªã©å‹æƒ…å ±ã«ã‚ˆã‚‹æ¤œè¨¼       |

---

## âœ… 11. resolve ã‚¯ãƒ¬ãƒ¼ãƒˆã®è²¬å‹™ã¾ã¨ã‚

### âœ… ã‚„ã‚‹ã“ã¨  
- ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€è§£æ±ºå‡¦ç†  
  - `order` ã‚’è€ƒæ…®ã—ãŸè§£æ±ºé †åˆ¶å¾¡ã€è¿½è¨˜ã€‘  
- Function å®Ÿè¡Œ â†’ å€™è£œå–å¾—ã¨ãƒãƒƒãƒ”ãƒ³ã‚°  
- UI æŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®æä¾›  
- ã‚³ãƒãƒ³ãƒ‰æ–‡å­—åˆ—ã®çµ„ã¿ç«‹ã¦  
- ãƒ­ã‚°ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºè¡Œ

### âŒ ã‚„ã‚‰ãªã„ã“ã¨  
- UI å®Ÿè£…  
- ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ  
- ã‚¹ãƒ‹ãƒšãƒƒãƒˆã®èª­ã¿è¾¼ã¿  
- ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã‚„ã‚¢ãƒ—ãƒªåˆ¶å¾¡

---

## âœ… ã‚³ãƒ¼ãƒ‰ã¸ã®åæ˜ ï¼ˆè£œè¶³ï¼‰

#### `resolve_placeholders()` ã«è¿½åŠ ã•ã‚Œã‚‹å‡¦ç†ã‚¤ãƒ¡ãƒ¼ã‚¸
```rust
// 1. ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’åˆ†é¡
let (mut ordered, mut unordered): (Vec<_>, Vec<_>) = snippet.placeholders
    .iter()
    .partition(|ph| ph.order.is_some());

// 2. ordered ã‚’æ˜‡é †ã‚½ãƒ¼ãƒˆ
ordered.sort_by_key(|ph| ph.order.unwrap());

// 3. è§£æ±ºå‡¦ç†ï¼ˆordered â†’ unordered ã®é †ï¼‰
for ph in ordered.iter().chain(unordered.iter()) {
    resolve_placeholder(ph, ...)?;
}
```

